<template>
	<view class="content">
		<!-- 这里设置了z-paging加载时禁止自动调用reload方法，自行控制何时reload（懒加载），同时允许touchmove事件冒泡，否则无法横向滚动切换tab -->
		<z-paging ref="paging" @query="queryList" :list.sync="dataList" 
			:mounted-auto-call-reload="false" :refresher-angle-enable-change-continued="false"
			:touchmove-propagation-enabled="true" :use-custom-refresher="true" style="height: 100%;"
			
			:key='val' :refresherDefaultText='lans.pullDownRefresh' :loading-more-no-more-text="lans.theEnd"
			:refresherPullingText='lans.ReleaseRefresh' :refresherRefreshingText='lans.Refreshings'
			:loadingMoreDefaultText='lans.ClickMore' :loadingMoreLoadingText='lans.loadings'
			:loadingMoreNoMoreText='lans.NoMores' :loadingMoreFailText='lans.LoadFaileds'
			>
			<!-- 自定义下拉刷新view，若不设置，则使用z-paging自带的下拉刷新view -->
			<!-- <custom-refresher slot="refresher"></custom-refresher> -->
			<loading-merchant v-if="isLoad" />
			<!-- <empty-view slot="empty"></empty-view> -->
			<!-- 如果希望其他view跟着页面滚动，可以放在z-paging标签内 -->
			<!-- list数据，建议像下方这样在item外层套一个view，而非直接for循环item，因为slot插入有数量限制 -->
			<view class="box-content-item-comment-wrap">
				<view class="box-content-item-type">
					<view class="box-content-item-type-li flex-center" @click="typeClick(index)"
						:class="typeIndex==index?'box-content-item-type-li-active':''" v-for="(item,index) in typeList"
						:key="index">{{item.name}}</view>
				</view>
				<no-data v-if="dataList.length<=0"  :msg='lans.NoDatar'/>
				<view class="box-content-item-comment" v-if="dataList.length>0">
					<view class="box-content-item-comment-list">
						<view class="box-content-item-comment-list-li" v-for="(item,index) in dataList" :key="item.id">
							<view class="comment-list-li-top">
								<view class="comment-list-li-top-image">
									<image :src="item.member_avatar" mode="aspectFill">
									</image>
								</view>
								<view class="comment-list-li-top-info">
									<view class="comment-list-li-top-info-title">{{item.member_nickname}}</view>
									<view class="comment-list-li-top-info-score">
										<uni-rate :readonly="true" allow-half margin='6' size='14' v-model="item.star" />
										<text style="font-size: 28rpx;color: #999;">{{item.star}} {{lan.point}}<!-- 分 --></text>
									</view>
								</view>
							</view>
							<view class="comment-list-li-msg-content">
								{{item.content}}
							</view>
							<view class="comment-list-li-msg-time">
								{{item.createtime}}
							</view>
							<view class="comment-list-li-msg-image-arr">
								<image :src="i" mode="aspectFill" v-for="(i,j) in item.bimg" :key="j"
									@click="previewImg(item.bimg,j)">
								</image>
							</view>
							<!-- <view class="comment-list-li-msg-reply" v-if="false">
								<view class="comment-list-li-msg-reply-text">我的回复：</view>
								<view class="comment-list-li-msg-reply-content">
									感谢您的支持与认可！我们会继续努力提供更优质的服务与项目感谢您的支持与认可！我们会继续努力提供更优质的服务与项目
								</view>
							</view>
							<view class="comment-list-li-msg-wrap" v-if="false">
								<view class="comment-list-li-msg-wrap-text">查看订单</view>
								<view class="comment-list-li-msg-wrap-btn flex-center">追加回复
								</view>
								<view class="comment-list-li-msg-wrap-btn flex-center">回复顾客</view>
							</view> -->
						</view>
					</view>
				</view>
			</view>

		</z-paging>
	</view>
</template>

<script>
	import mixins from '../../static/js/mixins.js'
	export default {
		mixins: [mixins],
		data() {
			return {
				dataList: [],
				firstLoaded: false,
				isLoad: true,
				typeList: [{
						name: '全部',
						id: 0
					},
					{
						name: '好评',
						id: 1
					},
					{
						name: '中评',
						id: 2
					},
					{
						name: '差评',
						id: 3
					},
				],
				starId: 0,
				typeIndex: 0, //当前选择的评论类型
				lans:{},
				    val:0,
			}
		},

		props: {
			tabIndex: {
				type: Number,
				default: function() {
					return 0
				}
			},
			currentIndex: {
				type: Number,
				default: function() {
					return 0
				}
			},
			arr:{},

		},
		watch: {
			currentIndex: {
				handler(newVal) {
					if (newVal === this.tabIndex) {
						//懒加载，当滑动到当前的item时，才去加载
						if (!this.firstLoaded) {
							this.$nextTick(() => {
								this.$refs.paging.reload();
							})
						}
					}
				},
				immediate: true
			},
			arr(val){
				this.typeList.map(v=>{
					switch(v.id){
						case 0:
						v.name=val.Allu
						break
						case 1:
						v.name=val.Praiseq
						break
						case 2:
						v.name=val.Averageq
						break
						case 3:
						v.name=val.BadReviewq
						break
					}
				})
				this.lan=val
			}
		},
		created() {
			this.getLan()
		},
		methods: {
			queryList(pageNo, pageSize) {
				this.getDataList(pageNo, pageSize)
			},


			// 获取数据
			getDataList(num, size) {
				var vuedata = {
					page_index: num, // 请求页数，
					each_page: size, // 请求条数
					com_type: this.tabIndex != 1 ? '' : 2,
					star: this.starId,
					type: 2
				}
				this.apiget('pc/comment', vuedata).then(res => {
					if (res.status == 200) {
						let list = res.data.comment
						if (res.data.comment.length != 0) {
							this.firstLoaded = true;
						} 
						this.$refs.paging.addData(list);
						this.isLoad = false
					}
				});
			},
			// 评论类型点击
			typeClick(index) {
				this.typeIndex = index
				this.starId = this.typeList[index].id
				this.getDataList(1, 20)
			},
			// 请求语言包
			getLan() {
			   this.apiget('language/info', {
			         name: 'pullUp'
				}).then(res => {
				    if (res.status == 200) {
					this.lans = res.data.language
					this.val++
				     }
				  });
				},

		}
	}
</script>

<style scoped lang="scss">
	.box-content-item-comment-wrap {
		height: 100%;
		display: flex;
		flex-direction: column;

		.box-content-item-type {
			display: flex;
			align-items: center;
			padding: 30rpx 40rpx;
			box-sizing: border-box;

			.box-content-item-type-li {
				width: 182rpx;
				height: 60rpx;
				margin-right: 20rpx;
				border: 1rpx solid #CCCCCC;
				border-radius: 30rpx;
				color: #ccc;
				font-size: 28rpx;
				transition: 0.3s;
			}

			.box-content-item-type-li:last-child {
				margin-right: 0;
			}

			.box-content-item-type-li-active {
				border: 1rpx solid #26BF82;
				color: #fff;
				background: #26BF82;
			}
		}

		.box-content-item-comment {
			flex: 1;
			overflow-y: scroll;
			box-sizing: border-box;

			.box-content-item-comment-list {
				padding-left: 40rpx;
				box-sizing: border-box;
				// margin-bottom: 40rpx;

				.box-content-item-comment-list-li:last-child {
					margin-bottom: 0;
				}

				.box-content-item-comment-list-li {
					padding-right: 40rpx;
					box-sizing: border-box;
					border-bottom: 1rpx solid #ededed;
					padding-bottom: 20rpx;
					margin-top: 40rpx;

					.comment-list-li-top {
						display: flex;
						align-items: center;

						.comment-list-li-top-image {
							display: flex;
							align-items: center;

							image {
								width: 88rpx;
								height: 88rpx;
								border-radius: 50%;
							}
						}

						.comment-list-li-top-info {
							margin-left: 20rpx;
							flex: 1;
							height: 100%;

							.comment-list-li-top-info-title {
								font-size: 32rpx;
								color: #000;
							}

							.comment-list-li-top-info-score {
								margin-top: 10rpx;
								display: flex;
								align-items: center;

								text {
									margin-right: 6rpx;
									font-size: 24rpx;
									color: #999;
								}
							}
						}
					}

					.comment-list-li-msg-content {
						margin: 20rpx 0;
						font-size: 28rpx;
						color: #333;
					}

					.comment-list-li-msg-time {
						font-size: 24rpx;
						color: #999;
					}

					.comment-list-li-msg-image-arr {
						display: flex;
						align-items: center;
						margin-top: 20rpx;


						image {
							width: 160rpx;
							height: 160rpx;
							margin-right: 10rpx;
							margin-bottom: 10rpx;
							border-radius: 10rpx;
						}

						image:nth-child(4n) {
							margin-right: 0;
						}
					}

					.comment-list-li-msg-reply {
						margin-top: 20rpx;
						padding: 20rpx;
						box-sizing: border-box;
						min-height: 152rpx;
						background: #F7F7F7;
						border-radius: 10rpx;
						font-size: 28rpx;

						.comment-list-li-msg-reply-text {
							color: #999;
						}

						.comment-list-li-msg-reply-content {
							color: #333;
						}
					}

					.comment-list-li-msg-wrap {
						padding: 20rpx 0;
						display: flex;
						align-items: center;
						justify-content: space-between;
						font-size: 28rpx;

						.comment-list-li-msg-wrap-text {
							color: #999;
						}

						.comment-list-li-msg-wrap-btn {
							width: 176rpx;
							height: 60rpx;
							background: #26BF82;
							border-radius: 32rpx;
							color: #fff;
						}
					}
				}
			}

		}
	}
</style>
